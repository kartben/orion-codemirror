<!DOCTYPE html>
<html>
<head>
	<title>orion-codemirror plugin</title>
	<style type="text/css">
		ul#modelist {
			list-style-type: none;
			column-count: 3;
			-moz-column-count: 3;
			-webkit-column-count: 3;
			width: 40em;
		}
		ol>li { margin-bottom: 1em; }
		#url {	
			width: 60em;
			font-family: monospace;
			background: #ddd;
			padding: 15px;
		}
	</style>
	</script>
	<script src="http://orionhub.org/orion/plugin.js"></script>
	<script src="lib/orion/global.js"></script>
	<script src="lib/orion/eventTarget.js"></script>
	<script src="lib/orion/textModel.js"></script>
	<script src="lib/mirrorTextModel.js"></script>
	<script src="lib/mirror.js"></script>
	<script src="lib/highlighter.js"></script>
	<script>
		// For compatibility with perl mode, which does naughty non-API things to CodeMirror.StringStream.prototype
		CodeMirror.StringStream = orion.codeMirror.Stream;
	</script>
	<!-- Mode scripts. TODO: inject <script> for selected modes only, or use requirejs -->
	<script src="lib/codemirror2/mode/clike/clike.js"></script>
	<script src="lib/codemirror2/mode/clojure/clojure.js"></script>
	<script src="lib/codemirror2/mode/coffeescript/coffeescript.js"></script>
	<script src="lib/codemirror2/mode/css/css.js"></script>
	<script src="lib/codemirror2/mode/diff/diff.js"></script>
	<script src="lib/codemirror2/mode/groovy/groovy.js"></script>
	<script src="lib/codemirror2/mode/haskell/haskell.js"></script>
	<script src="lib/codemirror2/mode/htmlmixed/htmlmixed.js"></script>
	<script src="lib/codemirror2/mode/javascript/javascript.js"></script>
	<script src="lib/codemirror2/mode/jinja2/jinja2.js"></script>
	<script src="lib/codemirror2/mode/lua/lua.js"></script>
	<script src="lib/codemirror2/mode/markdown/markdown.js"></script>
	<script src="lib/codemirror2/mode/ntriples/ntriples.js"></script>
	<script src="lib/codemirror2/mode/pascal/pascal.js"></script>
	<script src="lib/codemirror2/mode/perl/perl.js"></script>
	<script src="lib/codemirror2/mode/php/php.js"></script>
	<script src="lib/codemirror2/mode/plsql/plsql.js"></script>
	<script src="lib/codemirror2/mode/python/python.js"></script>
	<script src="lib/codemirror2/mode/r/r.js"></script>
	<script src="lib/codemirror2/mode/rst/rst.js"></script>
	<script src="lib/codemirror2/mode/ruby/ruby.js"></script>
	<script src="lib/codemirror2/mode/rust/rust.js"></script>
	<script src="lib/codemirror2/mode/scheme/scheme.js"></script>
	<script src="lib/codemirror2/mode/smalltalk/smalltalk.js"></script>
	<script src="lib/codemirror2/mode/sparql/sparql.js"></script>
	<script src="lib/codemirror2/mode/stex/stex.js"></script>
	<script src="lib/codemirror2/mode/tiddlywiki/tiddlywiki.js"></script>
	<script src="lib/codemirror2/mode/velocity/velocity.js"></script>
	<script src="lib/codemirror2/mode/xml/xml.js"></script>
	<script src="lib/codemirror2/mode/xmlpure/xmlpure.js"></script>
	<script src="lib/codemirror2/mode/yaml/yaml.js"></script>
	<!-- END -->
	<script>
	var modes = ["clike", "clojure", "coffeescript", "css", "diff", "groovy", "haskell", "htmlmixed", "javascript", "jinja2", "lua", "markdown", "ntriples", "pascal", "perl", "php", "plsql", "python", "r", "rst", "ruby", "rust", "scheme", "smalltalk", "sparql", "stex", "tiddlywiki", "velocity", "xml", "xmlpure", "yaml"];
var defaults = ["clike", "xml", "javascript", "css", "htmlmixed", "ruby", "perl", "markdown", "php"];
//var required = ["clike"]; // TODO some modes depend on others (eg. htmlmixed -> css)

function boxes() {
	return Array.prototype.filter.call(document.getElementsByTagName("input"), function(i){ return i.type === "checkbox"; });
}

function updateURL() {
	var base = window.location.href.replace(window.location.hash, "");
	var q = boxes().map(function(box) { return box.checked && box.value; }).filter(function(b) { return !!b; });
	var hash = q.join("+");
	document.getElementById("url").value = base + hash;
	window.location.hash = hash;
}

function createForm() {
	var list = document.getElementById("modelist");
	modes.forEach(function(mode) {
		var li = document.createElement("li");
		var label = document.createElement("label");
		var checkbox = document.createElement("input");
		checkbox.type = "checkbox";
		checkbox.value = mode;
		label.addEventListener("click", updateURL, false);
		
		label.appendChild(checkbox);
		label.appendChild(document.createTextNode(mode));
		li.appendChild(label);
		list.appendChild(li);
	});
}

function check(/*"all"|"none"|Array*/ what) {
	boxes().forEach(function(box) {
		box.checked = (what === "all" || (what instanceof Array && what.indexOf(box.value) !== -1));
	});
	updateURL();
}

function focusUrl() {
	var url = document.getElementById("url");
	url.focus();
	url.select();
}

window.onload = function() {
	var hash = (window.location.hash).substring(1);
	var toInstall = hash && hash.split("+");
	toInstall = (toInstall && toInstall.length) ? toInstall : defaults;
	console.debug("modes to install: [" + toInstall.join(",") + "]");
	try {
		var provider = new eclipse.PluginProvider();
		var serviceProvider = provider.registerServiceProvider("orion.edit.model", 
			new orion.editor.MirrorTextModel,
			{	types: ["ModelChanging"]
			});

		// This is the part that will dispatch highlight updates on itself
		var serviceProvider = provider.registerServiceProvider("orion.edit.highlight", {}, {});
		provider.connect();
	} catch (e) {
		console.debug("Couldn't install plugin: " + e);
		createForm();
		check(toInstall);
		updateURL();
	}
};
	</script>
</head>
<body>
<h1>orion-codemirror</h1>
<p>This is a plugin for Orion that provides syntax highlighting using <a href="https://github.com/marijnh/CodeMirror2">CodeMirror</a> 
<a href="http://codemirror.net/manual.html#modeapi">modes</a>. See below for installation instructions.</p>

<h2>Requirements</h2>
<ul><li><a href="http://download.eclipse.org/orion/">Orion 0.4 M1</a></li></ul>

<h2>Installation</h2>
<form>
	<ol>
		<li>Check the modes that you want to enable support for:
			<div class="cols">
				<ul id="modelist"></ul>
			</div>
			<button type="button" onclick="check('all')">Check All</button>
			<button type="button" onclick="check('none')">Check None</button>
			<button type="button" onclick="check(defaults)">Defaults</button></li>
		<li>Copy the resulting URL from this box:<br>
			<textarea id="url" type="text" onclick="focusUrl()" rows="1" wrap="off"></textarea>
		</li>
		<li>Log in to your Orion environment, go to the "Plugins" page, paste the URL into the "Install" field, and click Install.</li>
		<li>????</li>
		<li>Profit</li>
	</ol>
</form>
</body>
</html>