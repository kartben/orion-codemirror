<!DOCTYPE html>
<html>
<head>
	<title>orion-codemirror plugin</title>
	<style type="text/css">
		ul.modelist {
			list-style-type: none;
			column-count: 3;
			-moz-column-count: 3;
			-webkit-column-count: 3;
			width: 40em;
		}
		ol>li { margin-bottom: 1em; }
		.url {
			width: 60em;
			font-family: monospace;
			background: #ddd;
			padding: 15px;
			white-space: nowrap;
			overflow-x: scroll;
			/*overflow-y: hidden;*/
			overflow: '-moz-scrollbars-horizontal';
		}
	</style>
	<script src="lib/orion/plugin.js"></script>
	<script src="lib/orion/global.js"></script>
	<script src="lib/orion/eventTarget.js"></script>
	<script src="lib/orion/textModel.js"></script>
	<script src="lib/mirrorTextModel.js"></script>
	<script src="lib/mirror.js"></script>
	<script src="lib/highlighter.js"></script>
	<script>
		/*global CodeMirror orion*/
		// For compatibility with perl mode, which does naughty non-API things to CodeMirror.StringStream
		CodeMirror.StringStream = orion.codemirror.Stream;
	</script>
	<script src="lib/codemirror2-compressed/modes-compressed.js"></script>
	<script src="lib/codemirror2/mode/htmlmixed/htmlmixed.js"></script> <!-- steal text/html back from xml mode (FIXME) -->
	<script>
/*global console eclipse CodeMirror orion window*/
// Invert 1:1 map
function invert(obj) {
	var result = {};
	for (var key in obj) {
		if (obj.hasOwnProperty(key)) {
			var arr = obj[key];
			if (arr instanceof Array) {
				for (var i=0; i < arr.length; i++) {
					var val = arr[i];
					result[val] = key;
				}
			} else {
				result[arr] = key;
			}
		}
	}
	return result;
}

var modes = ["clike", "clojure", "coffeescript", "css", "diff", "groovy", "haskell", "htmlmixed", "javascript", "jinja2", "lua", "markdown", "ntriples", "pascal", "perl", "php", "plsql", "python", "r", "rst", "ruby", "rust", "scheme", "smalltalk", "sparql", "stex", "tiddlywiki", "velocity", "xml", "xmlpure", "yaml"];
var defaults = ["clike", "css", "htmlmixed", "javascript", "perl", "php", "ruby", "xml"];
var deps = {
	"htmlmixed": ["css", "xml", "javascript"],
	"php": ["clike", "css", "javascript", "xml"]
};
var mime2ContentType = {
	"text/x-csrc": "text.c",
	"text/x-c++src": "text.cpp",
	"text/x-clojure": "text.clojure",
	"text/x-coffeescript": "text.coffeescript",
	"text/x-csharp": "text.csharp",
	"text/css": "text.css", // orion
	"text/x-diff": "text.diff",
	"text/x-groovy": "text.groovy",
	"text/x-haskell": "text.haskell",
	"text/html": "text.html", // orion
	"text/x-java": "text.java", // orion
	"text/javascript": "text.javascript", // orion
	"application/json": "text.json", // orion
	"jinja2": "text.jinja2",
	"text/x-lua": "text.lua",
	"text/x-markdown": "text.markdown",
	"text/n-triples": "text.ntriples",
	"text/x-pascal": "text.pascal",
	"text/x-perl": "text.perl",
	"text/x-php": "text.php",
	"application/x-httpd-php": "text.html+php",
	"text/x-plsql": "text.plsql",
	"text/x-python": "text.python",
	"text/x-rsrc": "text.r",
	"text/x-rst": "text.restructuredtext",
	"text/x-ruby": "text.ruby",
	"text/x-rustsrc": "text.rust",
	"text/x-scheme": "text.scheme",
	"text/x-stsrc": "text.sm",
	"application/x-sparql-query": "text.sparql",
	"text/stex": "text.stex",
	"text/x-tiddlywiki": "text.tiddlywiki",
	"text/velocity": "text.velocity",
	"text/xml": "text.xml", // orion
	/*"application/xml": ["xml"],*/
	"text/x-yaml": "text.yaml"
};
var contentType2Mime = invert(mime2ContentType);
var mime2Ext = {
	"text/x-csrc": ["c", "C", "h"],
	"text/x-c++src": ["cc", "cpp", "c++"],
	"text/x-clojure": ["clj"],
	"text/x-coffeescript": ["coffee"],
	"text/x-csharp": ["cs"],
	"text/css": ["css"],
	"text/x-diff": ["diff", "patch"],
	"text/x-groovy": ["groovy"],
	"text/x-haskell": ["hs"],
	"text/html": ["html", "htm"],
	"text/x-java": ["java"],
	"text/javascript": ["js"],
	"application/json": ["json"],
	"jinja2": [],
	"text/x-lua": ["lua"],
	"text/x-markdown": ["md"],
	"text/n-triples": ["nt"],
	"text/x-pascal": ["pascal", "p"],
	"text/x-perl": ["pl"],
	"text/x-php": ["php", "php3", "php4", "php5"],
	"application/x-httpd-php": ["phtml"],
	"text/x-plsql": ["sql"],
	"text/x-python": ["py"],
	"text/x-rsrc": ["r"],
	"text/x-rst": ["rst"],
	"text/x-ruby": ["rb"],
	"text/x-rust": ["rs", "rc"],
	"text/x-scheme": ["scm", "ss"],
	"text/x-stsrc": ["sm"],
	"application/x-sparql-query": ["spk"],
	"text/stex": [],
	"text/x-tiddlywiki": [],
	"text/velocity": [],
	"text/xml": ["xml"],
	/*"application/xml": ["xml"],*/
	"text/x-yaml": ["yaml"]
};
var ext2Mime = invert(mime2Ext);

function getMime(contentType) {
	return contentType2Mime[contentType.id];
}
function getContentTypeId(mime) {
	return mime2ContentType[mime];
}
function getMimes(modes) {
	return CodeMirror.listMIMEs().filter(
		function(mime) {
			var mname = CodeMirror._getModeName(mime);
			return modes.indexOf(mname) !== -1;
		});
}
// TODO this can go away once highlighter service is not extension-dependent
function getFileTypes(modes) {
		return getMimes(modes).reduce(function(prev, mime) {
			Array.prototype.push.apply(prev, mime2Ext[mime]);
			return prev;
		}, []);
}
// Create Orion content types for modes
function getContentTypes(modes) {
	return getMimes(modes).map(function(mime) {
		// Turn it into a content type (some may already be defined, like text.html)
		var id = getContentTypeId(mime);
		return id && {
			id: id,
			extension: mime2Ext[mime],
			"extends": "text.plain"
		};
	}).filter(function(ct) { return !!ct; });
}
function boxes() {
	return Array.prototype.filter.call(document.getElementsByTagName("input"), function(i){ return i.type === "checkbox"; });
}
function updateURL() {
	var base = window.location.href.replace(window.location.hash, "");
	var q = boxes().map(function(box) { return box.checked && box.value; }).filter(function(b) { return !!b; });
	var hash = q.join("+");
	document.getElementById("url").value = base + (base[base.length-1] !== "#" ? "#" : "") + hash;
	window.location.hash = hash;
}
function add(what) {
	boxes().forEach(function(box) {
		box.checked = box.checked || what.indexOf(box.value) !== -1;
	});
}
function onBoxClick(e) {
	if (e.target.tagName === "LABEL") { return; }
	var box = e.target;
	if (deps[box.value]) { add(deps[box.value], true); }
	updateURL();
}
function createForm() {
	var list = document.getElementById("modelist");
	modes.forEach(function(mode) {
		var li = document.createElement("li");
		var label = document.createElement("label");
		var checkbox = document.createElement("input");
		checkbox.type = "checkbox";
		checkbox.value = mode;
		label.addEventListener("click", onBoxClick, false);
		label.appendChild(checkbox);
		label.appendChild(document.createTextNode(mode));
		li.appendChild(label);
		list.appendChild(li);
	});
}

function check(/*"all"|"none"|Array*/ what) {
	boxes().forEach(function(box) {
		box.checked = (what === "all" || (what instanceof Array && what.indexOf(box.value) !== -1));
	});
	updateURL();
}

function regexEscape(s) {
	return s.replace(/([\\$\^*\/+?\.\(\)|{}\[\]])/g, "\\$&");
}

function errback(e) { console.debug("orion-codemirror: Couldn't install plugin: " + e); }

window.onload = function() {
	var hash = (window.location.hash).substring(1);
	var modeSet = hash && hash.split("+");
	modeSet = (modeSet && modeSet.length) ? modeSet : defaults; // modeSet to install
	try {
		var model = new orion.editor.MirrorTextModel();
		var highlighter = new orion.codemirror.Highlighter(model);
		var contentTypes = getContentTypes(modeSet);
		
		var provider = new eclipse.PluginProvider();
		var serviceProvider = provider.registerServiceProvider("orion.edit.model", 
			{	
				onModelChanging: function(modelChangingEvent) {
					model.onTargetModelChanging(modelChangingEvent);
				},
				onScroll: function(scrollEvent) {
					highlighter.setViewportIndex(scrollEvent.topIndex);
				}
			},
			{ types: ["ModelChanging", "Scroll"],
			  contentType: contentTypes
			});
		
		// Register editor associations for installed modes
		provider.registerServiceProvider("orion.file.contenttype", {},
			{	contentTypes: contentTypes
			});
		provider.registerServiceProvider("orion.navigate.openWith", {},
			{	editor: "orion.editor",
				contentType: contentTypes.map(function(ct) { return ct.id; })
			});

		var highlightServiceProvider = provider.registerServiceProvider("orion.edit.highlighter",
			{	setContentType: function(contentType) {
					var mime = getMime(contentType);
					if (mime) {
						//CodeMirror.setOption("mode", mime);
						highlighter.loadMode(mime);
					} else {
						console.debug("Missing MIME in content type " + contentType.id);
					}
				}
			},
			{ type: "highlighter",
			  fileTypes: getFileTypes(modeSet)
			});
		highlighter.addEventListener("StyleReady", function(styleReadyEvent) {
			highlightServiceProvider.dispatchEvent("orion.edit.highlighter.styleReady", styleReadyEvent);
		});
		
		provider.connect(function(e){
			console.debug("orion-codemirror: connected. Supported modes: [" + modeSet.join(",") + "]");
		}, errback);
	} catch (e) {
		errback(e);
	}
	
	createForm();
	check(modeSet);
	updateURL();
};
	</script>
</head>
<body>
<h1>orion-codemirror</h1>
<p>This is a plugin for Orion that provides syntax highlighting using <a href="https://github.com/marijnh/CodeMirror2">CodeMirror</a> 
<a href="http://codemirror.net/manual.html#modeapi">modes</a>. See below for installation instructions.</p>

<h2>Requirements</h2>
<ul>
	<li><a href="http://download.eclipse.org/orion/">Orion 0.4</a></li>
</ul>

<h2>Installation</h2>
<form>
	<ol>
		<li>Check the modes that you want to enable support for:
			<div class="cols">
				<ul id="modelist" class="modelist"></ul>
			</div>
			<button type="button" onclick="check('all');">Check All</button>
			<button type="button" onclick="check('none');">Check None</button>
			<button type="button" onclick="check(defaults);">Defaults</button></li>
		<li>Copy the resulting URL from this box:<br>
			<textarea id="url" class="url" type="text" onclick="this.focus(); this.select();" rows="1" wrap="off"></textarea>
		</li>
		<li>Log in to your Orion environment, go to the "Plugins" page, paste the URL into the "Install" field, and click Install.</li>
	</ol>
</form>

<h2>Usage</h2>
<ol>
  <li>In Orion, go to the Navigator page.</li>
  <li>Create a new file with an extension corresponding to one of the modes you installed. (For example, <code>test.php</code> if you installed PHP mode). Click on it.</li>
  <li>You'll be taken to an editing page. Type some (valid) code in the editor, and it will be syntax-colored.</li>
</ol>
</body>
</html>
