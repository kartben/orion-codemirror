<!DOCTYPE html>
<html>
<head>
	<title>CodeMirror modes</title>
	<style type="text/css">
		ul#modelist {
			list-style-type: none;
			column-count: 3;
			-moz-column-count: 3;
			-webkit-column-count: 3;
			width: 40em;
		}
		ol>li { margin-bottom: 1em; }
		#url {	
			width: 60em;
			font-family: monospace;
			background: #ddd;
			padding: 15px;
		}
	</style>
	</script>
	<script src="http://orionhub.org/orion/plugin.js"></script>
	<script src="lib/global.js"></script>
	<script src="lib/eventTarget.js"></script>
	<script src="lib/textModel.js"></script>
	<script src="lib/mirrorTextModel.js"></script>
	<script>
var modes = ["clike", "diff", "javascript", "ntriples", "plsql", "ruby", "sparql", "xml", "clojure", "groovy", "jinja2", "pascal", "python", "rust", "stex", "xmlpure", "coffeescript", "haskell", "lua", "perl", "r", "scheme", "tiddlywiki", "yaml", "css", "htmlmixed", "markdown", "php", "rst", "smalltalk", "velocity"].sort();
var defaults = ["clike", "xml", "javascript", "css", "htmlmixed", "ruby", "perl", "markdown", "php"];
var required = ["clike"]; // TODO some modes depend on others (eg. htmlmixed -> css)

function boxes() {
	return Array.prototype.filter.call(document.getElementsByTagName("input"), function(i){ return i.type === "checkbox"; });
}

function updateURL() {
	var base = window.location.href.replace(window.location.hash, "");
	var q = boxes().map(function(box) { return box.checked && box.value; }).filter(function(b) { return b; });
	var hash = q.join("+");
	document.getElementById("url").value = base + hash;
	window.location.hash = hash;
}

function createForm() {
	var list = document.getElementById("modelist");
	modes.forEach(function(mode) {
		var li = document.createElement("li");
		var label = document.createElement("label");
		var checkbox = document.createElement("input");
		checkbox.type = "checkbox";
		checkbox.value = mode;
		label.addEventListener("click", updateURL, false);
		
		label.appendChild(checkbox);
		label.appendChild(document.createTextNode(mode));
		li.appendChild(label);
		list.appendChild(li);
	});
}

function check(/*"all"|"none"|Array*/ what) {
	boxes().forEach(function(box) {
		box.checked = (what === "all" || (what instanceof Array && what.indexOf(box.value) !== -1));
	});
	updateURL();
}

function focusUrl() {
	var url = document.getElementById("url");
	url.focus();
	url.select();
}

window.onload = function() {
	var hash = (window.location.hash).substring(1);
	var toInstall = hash && hash.split("+");
	toInstall = (toInstall && toInstall .length) ? toInstall : defaults;
	console.debug("modes to install: [" + toInstall.join(",") + "]");
	try {
		var provider = new eclipse.PluginProvider();
		var serviceProvider = provider.registerServiceProvider("orion.edit.listener", 
			new orion.editor.MirrorTextModel(orion.textview),
			{ types: ["ModelChanging"] });
		var serviceProvider = provider.registerServiceProvider("orion.edit.highlight", {}, {});
		provider.connect();
	} catch (e) {
		console.debug("Couldn't install plugin: " + e);
		createForm();
		check(toInstall);
		updateURL();
	}
};
	</script>
</head>
<body>
<h1>CodeMirror modes</h1>
<p>This is a plugin for Orion that provides syntax highlighting using <a href="https://github.com/marijnh/CodeMirror2">CodeMirror</a> 
<a href="http://codemirror.net/manual.html#modeapi">modes</a>. See below for installation instructions.</p>

<h2>Requirements</h2>
<ul><li><a href="http://download.eclipse.org/orion/">Orion 0.4 M1</a></li></ul>

<h2>Installation</h2>
<form>
	<ol>
		<li>Check the modes that you want to enable support for:
			<div class="cols">
				<ul id="modelist"></ul>
			</div>
			<button type="button" onclick="check('all')">Check All</button>
			<button type="button" onclick="check('none')">Check None</button>
			<button type="button" onclick="check(defaults)">Defaults</button></li>
		<li>Copy the resulting URL from this box:<br>
			<textarea id="url" type="text" onclick="focusUrl()" rows="1" wrap="off"></textarea>
		</li>
		<li>Log in to your Orion environment, go to the "Plugins" page, paste the URL into the "Install" field, and click Install.</li>
		<li>????</li>
		<li>Profit</li>
	</ol>
</form>
</body>
</html>