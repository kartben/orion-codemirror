<!DOCTYPE html>
<html>
<head>
	<title>orion-codemirror plugin</title>
	<style type="text/css">
		ul.modelist {
			list-style-type: none;
			column-count: 3;
			-moz-column-count: 3;
			-webkit-column-count: 3;
			width: 40em;
		}
		ol>li { margin-bottom: 1em; }
		.url {
			width: 60em;
			font-family: monospace;
			background: #ddd;
			padding: 15px;
			white-space: nowrap;
			overflow-x: scroll;
			/*overflow-y: hidden;*/
			overflow: -moz-scrollbars-horizontal;
		}
	</style>
	<script src="lib/orion/plugin.js"></script>
	<script src="lib/orion/global.js"></script>
	<script src="lib/orion/eventTarget.js"></script>
	<script src="lib/orion/textModel.js"></script>
	<script src="lib/mirrorTextModel.js"></script>
	<script src="lib/mirror.js"></script>
	<script src="lib/highlighter.js"></script>
	<script>
		// For compatibility with perl mode, which does naughty non-API things to CodeMirror.StringStream.prototype
		CodeMirror.StringStream = orion.codemirror.Stream;
	</script>
	<!-- Mode scripts. TODO: inject <script> for selected modes only, or use requirejs -->
	<script src="lib/codemirror2/mode/clike/clike.js"></script>
	<script src="lib/codemirror2/mode/clojure/clojure.js"></script>
	<script src="lib/codemirror2/mode/coffeescript/coffeescript.js"></script>
	<script src="lib/codemirror2/mode/css/css.js"></script>
	<script src="lib/codemirror2/mode/diff/diff.js"></script>
	<script src="lib/codemirror2/mode/groovy/groovy.js"></script>
	<script src="lib/codemirror2/mode/haskell/haskell.js"></script>
	<script src="lib/codemirror2/mode/javascript/javascript.js"></script>
	<script src="lib/codemirror2/mode/jinja2/jinja2.js"></script>
	<script src="lib/codemirror2/mode/lua/lua.js"></script>
	<script src="lib/codemirror2/mode/markdown/markdown.js"></script>
	<script src="lib/codemirror2/mode/ntriples/ntriples.js"></script>
	<script src="lib/codemirror2/mode/pascal/pascal.js"></script>
	<script src="lib/codemirror2/mode/perl/perl.js"></script>
	<script src="lib/codemirror2/mode/php/php.js"></script>
	<script src="lib/codemirror2/mode/plsql/plsql.js"></script>
	<script src="lib/codemirror2/mode/python/python.js"></script>
	<script src="lib/codemirror2/mode/r/r.js"></script>
	<script src="lib/codemirror2/mode/rst/rst.js"></script>
	<script src="lib/codemirror2/mode/ruby/ruby.js"></script>
	<script src="lib/codemirror2/mode/rust/rust.js"></script>
	<script src="lib/codemirror2/mode/scheme/scheme.js"></script>
	<script src="lib/codemirror2/mode/smalltalk/smalltalk.js"></script>
	<script src="lib/codemirror2/mode/sparql/sparql.js"></script>
	<script src="lib/codemirror2/mode/stex/stex.js"></script>
	<script src="lib/codemirror2/mode/tiddlywiki/tiddlywiki.js"></script>
	<script src="lib/codemirror2/mode/velocity/velocity.js"></script>
	<script src="lib/codemirror2/mode/xml/xml.js"></script>
	<script src="lib/codemirror2/mode/xmlpure/xmlpure.js"></script>
	<script src="lib/codemirror2/mode/htmlmixed/htmlmixed.js"></script> <!-- must load after xml to grab text/html MIME -->
	<script src="lib/codemirror2/mode/yaml/yaml.js"></script>
	<!-- END -->
	<script>
var modes = ["clike", "clojure", "coffeescript", "css", "diff", "groovy", "haskell", "htmlmixed", "javascript", "jinja2", "lua", "markdown", "ntriples", "pascal", "perl", "php", "plsql", "python", "r", "rst", "ruby", "rust", "scheme", "smalltalk", "sparql", "stex", "tiddlywiki", "velocity", "xml", "xmlpure", "yaml"];
var defaults = ["clike", "css", "htmlmixed", "javascript", "perl", "php", "ruby", "xml"];
var deps = {
	"htmlmixed": ["css", "xml", "javascript"],
	"php": ["clike", "css", "javascript", "xml"]
};
var mime2Ext = {
	"text/x-csrc": ["c", "C", "h"],
	"text/x-c++src": ["cc", "cpp", "c++"],
	"text/x-clojure": ["clj"],
	"text/x-coffeescript": ["cs"],
	"text/css": ["css"],
	"text/x-diff": ["diff", "patch"],
	"text/x-groovy": ["groovy"],
	"text/x-haskell": ["hs"],
	"text/html": ["html", "htm"],
	"text/x-java": ["java"],
	"text/javascript": ["js"],
	"application/json": ["json"],
	"jinja2": [],
	"lua": ["lua"],
	"text/x-markdown": ["md"],
	"text/n-triples": ["nt"],
	"text/x-pascal": ["pascal", "p"],
	"text/x-perl": ["pl"],
	"text/x-php": ["php", "php3", "php4", "php5"],
	"application/x-httpd-php": ["phtml"],
	"text/x-plsql": ["sql"],
	"text/x-python": ["py"],
	"text/x-rsrc": ["r"],
	"text/x-rst": ["rst"],
	"text/x-ruby": ["rb"],
	"text/x-rust": ["rs", "rc"],
	"text/x-scheme": ["scm", "ss"],
	"text/x-stsrc": ["sm"],
	"application/x-sparql-query": ["spk"],
	"text/stex": [],
	"text/x-tiddlywiki": [],
	"text/velocity": [],
	"text/xml": ["xml"],
	/*"application/xml": ["xml"],*/
	"text/x-yaml": ["yaml"]
};
var ext2Mime = invert(mime2Ext);

// Invert 1:1 map whose values are arrays
function invert(obj) {
	var result = {};
	for (var key in obj) {
		if (!(obj.hasOwnProperty(key))) { continue; }
		var arr = obj[key];
		for (var i=0; i < arr.length; i++) {
			var val = arr[i];
			result[val] = key;
		}
	}
	return result;
}

function getFileTypes(modes) {
	// A mime passes this filter only if it's contributed by a mode in modes
	function onlyCheckedMimes(mime) {
		var mname = CodeMirror._getModeName(mime);
		return modes.indexOf(mname) !== -1;
	}
	return CodeMirror.listMIMEs()
		.filter(onlyCheckedMimes)
		.reduce(function(prev, mime) {
			Array.prototype.push.apply(prev, mime2Ext[mime]);
			return prev;
		}, []);
}

function getMimeFor(ext) {
	return ext2Mime[ext];
}

function boxes() {
	return Array.prototype.filter.call(document.getElementsByTagName("input"), function(i){ return i.type === "checkbox"; });
}

function updateURL() {
	var base = window.location.href.replace(window.location.hash, "");
	var q = boxes().map(function(box) { return box.checked && box.value; }).filter(function(b) { return !!b; });
	var hash = q.join("+");
	document.getElementById("url").value = base + (base[base.length-1] !== "#" ? "#" : "") + hash;
	window.location.hash = hash;
}

function createForm() {
	var list = document.getElementById("modelist");
	modes.forEach(function(mode) {
		var li = document.createElement("li");
		var label = document.createElement("label");
		var checkbox = document.createElement("input");
		checkbox.type = "checkbox";
		checkbox.value = mode;
		label.addEventListener("click", onBoxClick, false);
		label.appendChild(checkbox);
		label.appendChild(document.createTextNode(mode));
		li.appendChild(label);
		list.appendChild(li);
	});
}

function onBoxClick(e) {
	if (e.target.tagName === "LABEL") { return; }
	var box = e.target;
	if (deps[box.value]) { add(deps[box.value], true); }
	updateURL();
}

function add(what) {
	boxes().forEach(function(box) {
		box.checked = box.checked || what.indexOf(box.value) !== -1;
	});
}

function check(/*"all"|"none"|Array*/ what) {
	boxes().forEach(function(box) {
		box.checked = (what === "all" || (what instanceof Array && what.indexOf(box.value) !== -1));
	});
	updateURL();
}

function regexEscape(s) {
	return s.replace(/([\\$\^*\/+?\.\(\)|{}\[\]])/g, "\\$&");
}

function errback(e) { console.debug("orion-codemirror: Couldn't install plugin: " + e); }

window.onload = function() {
	var hash = (window.location.hash).substring(1);
	var toInstall = hash && hash.split("+");
	toInstall = (toInstall && toInstall.length) ? toInstall : defaults;
	try {
		var model = new orion.editor.MirrorTextModel();
		var highlighter = new orion.codemirror.Highlighter(model);
		
		var provider = new eclipse.PluginProvider();
		var serviceProvider = provider.registerServiceProvider("orion.edit.model", 
			{	
				onModelChanging: function(modelChangingEvent) {
					model.onTargetModelChanging(modelChangingEvent);
				}
			},
			{ types: ["ModelChanging"] });

		var highlightServiceProvider = provider.registerServiceProvider("orion.edit.highlighter",	// Needs to dispatch events
			{
				setExtension: function(extension) {
					var mime = getMimeFor(extension);
					//CodeMirror.setOption("mode", mime);
					highlighter.loadMode(mime);
				}
			},
			{ type: "highlighter",
			  fileTypes: getFileTypes(toInstall)
			});
		highlighter.addEventListener("StyleReady", function(styleReadyEvent) {
			highlightServiceProvider.dispatchEvent("orion.edit.highlighter.styleReady", styleReadyEvent);
		});
		
		// Register file associations for installed modes
		var fileExts = getFileTypes(toInstall).map(regexEscape).join("|");
		provider.registerServiceProvider("orion.navigate.openWith", {},
			{	name: "Orion web editor",
				href: "../edit/edit.html#${Location}",
				validationProperties: {Name: "*.(" + fileExts + ")"}
			});
		
		provider.connect(function(e){
			console.debug("orion-codemirror: connected. Supported modes: [" + toInstall.join(",") + "]");
		}, errback);
	} catch (e) {
		errback(e);
	}
	
	createForm();
	check(toInstall);
	updateURL();
};
	</script>
</head>
<body>
<h1>orion-codemirror</h1>
<p>This is a plugin for Orion that provides syntax highlighting using <a href="https://github.com/marijnh/CodeMirror2">CodeMirror</a> 
<a href="http://codemirror.net/manual.html#modeapi">modes</a>. See below for installation instructions.</p>

<h2>Requirements</h2>
<ul>
	<li><a href="http://download.eclipse.org/orion/">Orion 0.4 M1</a></li>
</ul>

<h2>Installation</h2>
<form>
	<ol>
		<li>Check the modes that you want to enable support for:
			<div class="cols">
				<ul id="modelist" class="modelist"></ul>
			</div>
			<button type="button" onclick="check('all')">Check All</button>
			<button type="button" onclick="check('none')">Check None</button>
			<button type="button" onclick="check(defaults)">Defaults</button></li>
		<li>Copy the resulting URL from this box:<br>
			<textarea id="url" class="url" type="text" onclick="this.focus(); this.select();" rows="1" wrap="off"></textarea>
		</li>
		<li>Log in to your Orion environment, go to the "Plugins" page, paste the URL into the "Install" field, and click Install.</li>
	</ol>
</form>

<h2>Usage</h2>
<ol>
  <li>In Orion, go to the Navigator page.</li>
  <li>Create a new file with an extension corresponding to one of the modes you installed. (For example, <code>test.php</code> if you installed PHP mode). Click on it.</li>
  <li>You'll be taken to an editing page. Type some (valid) code in the editor, and it will be syntax-colored.</li>
</ol>
</body>
</html>
